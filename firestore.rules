rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function isPlatformAdmin() {
      return signedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.role == "admin"
      );
    }

    function memberPath(orgId) {
      return /databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid);
    }

    function memberDoc(orgId) {
      return get(memberPath(orgId));
    }

    function isOrgMember(orgId) {
      return isPlatformAdmin() || (
        signedIn() &&
        exists(memberPath(orgId)) &&
        memberDoc(orgId).data.status == "active"
      );
    }

    function orgRole(orgId) {
      return isPlatformAdmin() ? "owner" : memberDoc(orgId).data.role;
    }

    function isOrgAdmin(orgId) {
      return isOrgMember(orgId) && orgRole(orgId) in ["owner", "admin"];
    }

    function canManageBilling(orgId) {
      return isOrgMember(orgId) && orgRole(orgId) in ["owner", "admin", "finance"];
    }

    function canManageSales(orgId) {
      return isOrgMember(orgId) && orgRole(orgId) in ["owner", "admin", "finance", "sales"];
    }

    function canReadBilling(orgId) {
      return isOrgMember(orgId);
    }

    match /users/{uid} {
      allow read, write: if signedIn() && uid == request.auth.uid;
      allow read, write: if isPlatformAdmin();
    }

    match /orgs/{orgId} {
      allow read: if isOrgMember(orgId);
      allow create: if isPlatformAdmin();
      allow update, delete: if isOrgAdmin(orgId);

      match /settings/{settingsId} {
        allow read: if canReadBilling(orgId);
        allow write: if isOrgAdmin(orgId);
      }

      match /members/{memberId} {
        allow read: if (signedIn() && memberId == request.auth.uid) || isOrgMember(orgId);
        allow create, update, delete: if isOrgAdmin(orgId);
      }

      match /clients/{clientId} {
        allow read: if canReadBilling(orgId);
        allow create, update: if canManageSales(orgId);
        allow delete: if canManageBilling(orgId);
      }

      match /items/{itemId} {
        allow read: if canReadBilling(orgId);
        allow create, update: if canManageSales(orgId);
        allow delete: if canManageBilling(orgId);
      }

      match /taxes/{taxId} {
        allow read: if canReadBilling(orgId);
        allow write: if canManageBilling(orgId);
      }

      match /invoices/{invoiceId} {
        allow read: if canReadBilling(orgId);
        allow create: if canManageBilling(orgId)
          || (canManageSales(orgId) && request.resource.data.status == "draft");
        allow update: if canManageBilling(orgId)
          || (canManageSales(orgId)
              && resource.data.status == "draft"
              && request.resource.data.status == "draft");
        allow delete: if canManageBilling(orgId);
      }

      match /estimates/{estimateId} {
        allow read: if canReadBilling(orgId);
        allow create: if canManageBilling(orgId)
          || (canManageSales(orgId) && request.resource.data.status == "draft");
        allow update: if canManageBilling(orgId)
          || (canManageSales(orgId)
              && resource.data.status == "draft"
              && request.resource.data.status == "draft");
        allow delete: if canManageBilling(orgId);
      }

      match /payments/{paymentId} {
        allow read: if canReadBilling(orgId);
        allow create: if canManageBilling(orgId) && request.resource.data.method == "manual";
        allow update, delete: if canManageBilling(orgId);
      }

      match /auditLogs/{logId} {
        allow read: if canManageBilling(orgId);
        allow write: if false;
      }

      match /publicTokens/{tokenId} {
        allow read, write: if false;
      }

      match /projects/{projectId} {
        allow read: if isOrgMember(orgId);
        allow write: if canManageSales(orgId);
      }

      match /assignments/{assignmentId} {
        allow read: if isOrgMember(orgId);
        allow write: if canManageSales(orgId);
      }

      match /tasks/{taskId} {
        allow read: if isOrgMember(orgId);
        allow write: if canManageSales(orgId);
      }
    }

    match /clients/{docId} { allow read, write: if false; }
    match /invoices/{docId} { allow read, write: if false; }
    match /projects/{docId} { allow read, write: if false; }
    match /tasks/{docId} { allow read, write: if false; }
    match /assignments/{docId} { allow read, write: if false; }
    match /items/{docId} { allow read, write: if false; }
    match /taxes/{docId} { allow read, write: if false; }
    match /payments/{docId} { allow read, write: if false; }
    match /auditLogs/{docId} { allow read, write: if false; }
    match /publicTokens/{docId} { allow read, write: if false; }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
